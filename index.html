<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spanish Flashcards ‚Äì Mastery Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top left, #1e293b, #0f172a 60%, #020617);
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: 1px solid rgba(148, 163, 184, 0.15);
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --gold: #eab308;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --radius-lg: 24px;
      --radius-sm: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; font-family: "Inter", sans-serif;
      background: var(--bg-gradient); color: var(--text-main);
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; padding: 10px;
    }

    /* --- Loading Screen --- */
    #loadingScreen {
      position: fixed; inset: 0; z-index: 9999; background: #0f172a;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s ease;
    }
    .loader-content { width: 80%; max-width: 400px; text-align: center; }
    .loading-bar-bg { width: 100%; height: 6px; background: rgba(148,163,184,0.2); border-radius: 99px; overflow: hidden; margin-bottom: 20px; }
    .loading-bar-fill { height: 100%; width: 30%; background: var(--accent); border-radius: 99px; animation: loadAnim 2s infinite ease-in-out; }
    @keyframes loadAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }
    .fun-fact-text { font-size: 16px; color: #bae6fd; margin-top: 10px; line-height: 1.5; min-height: 50px;}

    /* --- App Container --- */
    .app {
      width: 100%; max-width: 800px;
      background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: var(--card-border); border-radius: var(--radius-lg);
      overflow: hidden; display: flex; flex-direction: column; min-height: 85vh;
    }

    /* --- Header --- */
    .app-header { padding: 16px; border-bottom: var(--card-border); background: rgba(15, 23, 42, 0.8); }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .logo-block h1 { margin: 0; font-size: 18px; font-weight: 700; color: #fff; }
    .btn-settings { background: transparent; border: none; font-size: 20px; cursor: pointer; color: #fff; }

    /* Stats Pills */
    .stats-row { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .stat-pill {
      font-size: 11px; padding: 5px 12px; border-radius: 99px;
      background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--text-muted); cursor: pointer; transition: 0.2s;
    }
    .stat-pill strong { color: var(--text-main); font-weight: 600; margin-left: 4px; }
    .stat-pill.accent { border-color: rgba(34, 197, 94, 0.4); color: #bbf7d0; background: rgba(34, 197, 94, 0.1); }
    .stat-pill.danger { border-color: rgba(239, 68, 68, 0.4); color: #fecaca; background: rgba(239, 68, 68, 0.1); }
    .stat-pill.gold { border-color: rgba(234, 179, 8, 0.4); color: #fde047; background: rgba(234, 179, 8, 0.1); }

    /* Navigation */
    .nav-tabs { display: flex; gap: 6px; background: rgba(15, 23, 42, 0.6); padding: 4px; border-radius: 99px; margin-top: 12px; border: var(--card-border); }
    .nav-tab { flex: 1; border: none; background: transparent; color: var(--text-muted); padding: 8px; border-radius: 99px; font-size: 13px; cursor: pointer; }
    .nav-tab.active { background: var(--accent); color: #022c22; font-weight: 600; }

    /* --- Panels --- */
    .panel-container { flex: 1; display: flex; flex-direction: column; position: relative; }
    .panel { display: none; padding: 20px; animation: fadeIn 0.2s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    /* Decks Grid */
    .deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .deck-card {
      background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: var(--radius-sm); padding: 16px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; text-align: center; gap: 8px;
    }
    .deck-card:hover { background: rgba(30, 41, 59, 0.9); transform: translateY(-2px); }
    .deck-icon { font-size: 22px; }
    .deck-title { font-weight: 600; font-size: 13px; }
    .deck-count { font-size: 10px; color: var(--text-muted); }
    .deck-card.mastered-gold { border-color: var(--gold); background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(234, 179, 8, 0.15)); }

    /* Words Manager Layout */
    .menu-btn {
      width: 100%; padding: 20px; margin-bottom: 12px;
      background: rgba(30,41,59,0.5); border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-sm); color: #fff; font-size: 16px; font-weight: 600;
      cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .menu-btn:hover { background: rgba(30,41,59,0.8); border-color: var(--accent); }
    
    /* Search Bar Row */
    .search-row { display: flex; gap: 8px; margin-bottom: 15px; }
    .search-input {
      flex: 1; background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.2);
      padding: 12px; border-radius: var(--radius-sm); color: #fff; font-size: 14px; outline: none;
    }
    .search-input:focus { border-color: var(--accent); }
    .icon-btn {
      width: 44px; background: rgba(30,41,59,0.6); border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:hover { color: #fff; border-color: var(--text-muted); }

    /* Filter UI */
    .filter-options {
        background: #1e293b; border: 1px solid rgba(148,163,184,0.2);
        border-radius: var(--radius-sm); padding: 10px; margin-bottom: 15px;
        display: none; /* hidden by default */
        animation: fadeIn 0.2s;
    }
    .filter-group { margin-bottom: 10px; }
    .filter-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block;}
    .filter-chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip {
        padding: 6px 12px; font-size: 12px; border-radius: 99px;
        background: rgba(15,23,42,0.5); border: 1px solid rgba(148,163,184,0.2);
        color: var(--text-muted); cursor: pointer;
    }
    .chip.active { background: var(--accent); color: #022c22; font-weight: 600; border-color: var(--accent); }

    .word-list { display: flex; flex-direction: column; gap: 8px; }
    .word-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px; background: rgba(30,41,59,0.5);
      border-radius: var(--radius-sm); border: 1px solid rgba(148,163,184,0.1);
    }
    .word-main { font-weight: 600; color: #fff; font-size: 14px; }
    .word-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    
    .btn-play-selected {
        width: 100%; padding: 14px; margin-bottom: 15px;
        background: linear-gradient(135deg, var(--accent), #16a34a);
        color: #020617; border: none; border-radius: var(--radius-sm);
        font-weight: 700; font-size: 15px; cursor: pointer;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    .btn-show-more {
        width: 100%; padding: 10px; margin-top: 15px;
        background: transparent; border: 1px dashed rgba(148,163,184,0.3);
        color: var(--text-muted); border-radius: var(--radius-sm); cursor: pointer;
    }

    /* Game Card */
    .game-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; min-height: 400px; }
    .flashcard {
      width: 100%; max-width: 500px; min-height: 280px; padding: 30px;
      background: var(--bg-gradient); border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-lg); position: relative;
      display: flex; flex-direction: column; justify-content: space-between;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .flashcard.streak-flash { background: #064e3b !important; transition: background 0.1s; }
    .flashcard.correct { border-color: #22c55e; box-shadow: 0 0 25px rgba(34, 197, 94, 0.4); }
    .flashcard.wrong { border-color: #ef4444; box-shadow: 0 0 25px rgba(239, 68, 68, 0.4); }
    
    .word-text { font-size: 32px; font-weight: 700; color: #fff; text-align: center; margin: 20px 0; }
    .label-lang { font-size: 11px; text-transform: uppercase; color: var(--text-muted); text-align: center; letter-spacing: 1px;}

    /* Input/Buttons */
    .btn-action { flex: 1; padding: 12px; border-radius: 99px; font-weight: 600; cursor: pointer; border: none; }
    .btn-action.primary { background: var(--text-main); color: #020617; }
    .btn-action.ghost { background: transparent; color: var(--text-muted); border: 1px solid rgba(148,163,184,0.2); }
    .action-row { display: flex; gap: 10px; width: 100%; max-width: 400px; }

    /* Form Styles */
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .form-input { width: 100%; padding: 12px; background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.2); color: #fff; border-radius: var(--radius-sm); outline: none; }
    
    /* Edit Modal */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(2,6,23,0.9); z-index: 200;
        display: none; align-items: center; justify-content: center;
    }
    .modal-box { width: 90%; max-width: 400px; background: #1e293b; padding: 20px; border-radius: var(--radius-lg); border: 1px solid rgba(148,163,184,0.2); }

  </style>
</head>
<body>

<div id="loadingScreen">
  <div class="loader-content">
    <div class="loading-bar-bg"><div class="loading-bar-fill"></div></div>
    <div class="fun-fact-label" style="font-size:11px; color:#94a3b8; letter-spacing:1px; text-transform:uppercase;">Did you know?</div>
    <div class="fun-fact-text" id="funFactText">Loading...</div>
  </div>
</div>

<div class="app">
  <header class="app-header">
    <div class="header-top">
      <div class="logo-block"><h1>Spanish Flashcards</h1></div>
      <button class="btn-settings" onclick="alert('Settings placeholder')">‚öôÔ∏è</button>
    </div>
    
    <div class="stats-row">
      <div class="stat-pill accent" onclick="openWordsManagerFromHeader('known')">Known: <strong id="statKnown">0</strong></div>
      <div class="stat-pill danger" onclick="openWordsManagerFromHeader('struggle')">Struggle: <strong id="statStruggle">0</strong></div>
      <div class="stat-pill gold" onclick="openWordsManagerFromHeader('starred')">Starred: <strong id="statStarred">0</strong></div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-panel="decks">üìö Decks</button>
      <button class="nav-tab" data-panel="game">üéÆ Play</button>
      <button class="nav-tab" data-panel="words">üóÇ Words</button>
    </div>
  </header>

  <div class="panel-container">
    
    <div id="panel-decks" class="panel active">
      <h2 style="color:#fff; margin-bottom:15px">Let's start learning!</h2>
      <div id="deckGrid" class="deck-grid">Loading decks...</div>
    </div>

    <div id="panel-game" class="panel">
      <div class="game-area">
        <div class="flashcard" id="gameCard">
          <div>
            <div class="label-lang" id="gameDeckName">Deck Name</div>
            <div style="position:absolute; top:20px; right:20px; display:flex; gap:5px;">
                 <button id="btnEditCard" style="background:none; border:none; font-size:18px; cursor:pointer;" onclick="openEditForCurrentCard()">‚úèÔ∏è</button>
                 <button id="btnStarCard" style="background:none; border:none; font-size:18px; cursor:pointer;" onclick="toggleStar()">‚òÖ</button>
            </div>
          </div>
          <div>
            <div class="label-lang" id="gameFrontLabel">Spanish</div>
            <div class="word-text" id="gameFrontText">...</div>
            <div id="gameReveal" style="display:none; text-align:center; margin-top:20px; border-top:1px dashed #334155; padding-top:10px;">
                <div class="label-lang" id="gameBackLabel">English</div>
                <div style="font-size:24px; color:#bae6fd;" id="gameBackText">...</div>
            </div>
          </div>
          <div style="height:20px"></div>
        </div>

        <div class="action-row" id="gameControlsStart">
          <button class="btn-action primary" onclick="showAnswer()">Show Answer</button>
        </div>

        <div class="action-row" id="gameControlsJudge" style="display:none">
          <button class="btn-action ghost" style="color:#fca5a5; border-color:#fca5a5" onclick="markCard(false)">Still Learning</button>
          <button class="btn-action primary" style="background:#22c55e" onclick="markCard(true)">I Knew It</button>
        </div>
        
        <div class="action-row" id="gameControlsNext" style="display:none">
          <button class="btn-action primary" onclick="nextCard()">Next Card</button>
        </div>
      </div>
    </div>

    <div id="panel-words" class="panel">
      
      <div id="wordsMenu" style="margin-top:10px;">
        <button class="menu-btn" onclick="showAddSection()">
          <span>‚ûï Add New Cards</span> <span>‚Ä∫</span>
        </button>
        <button class="menu-btn" onclick="showManageSection()">
          <span>üìù Manage All Words</span> <span>‚Ä∫</span>
        </button>
      </div>

      <div id="sectionAdd" style="display:none;">
        <button onclick="showWordsMenu()" style="background:none; border:none; color:#94a3b8; margin-bottom:15px; cursor:pointer;">‚Äπ Back to Menu</button>
        <h3 style="color:#fff; margin-top:0">Add New Card</h3>
        <div class="form-group">
            <label>Spanish</label>
            <input type="text" id="addEs" class="form-input">
        </div>
        <div class="form-group">
            <label>English</label>
            <input type="text" id="addEn" class="form-input">
        </div>
        <div class="form-group">
            <label>Category</label>
            <select id="addTopicSelect" class="form-input"></select>
        </div>
        <button class="btn-action primary" style="width:100%" onclick="onAddSubmit()">Save Card</button>
        <div id="addMsg" style="text-align:center; margin-top:10px; font-size:12px;"></div>
      </div>

      <div id="sectionManage" style="display:none;">
        <button onclick="showWordsMenu()" style="background:none; border:none; color:#94a3b8; margin-bottom:15px; cursor:pointer;">‚Äπ Back to Menu</button>
        
        <div class="search-row">
            <input type="text" id="searchInput" class="search-input" placeholder="Search words..." onkeyup="resetPaginationAndRender()">
            <button class="icon-btn" onclick="toggleFilterUI()">üå™Ô∏è</button>
            <button class="icon-btn" onclick="toggleSort()">‚áÖ</button>
        </div>

        <div id="filterUI" class="filter-options">
            <div class="filter-group">
                <span class="filter-label">Status</span>
                <div class="filter-chips">
                    <span class="chip active" onclick="setFilter('status', 'all')" id="f-stat-all">All</span>
                    <span class="chip" onclick="setFilter('status', 'known')" id="f-stat-known">Known</span>
                    <span class="chip" onclick="setFilter('status', 'struggle')" id="f-stat-struggle">Struggle</span>
                    <span class="chip" onclick="setFilter('status', 'starred')" id="f-stat-starred">Starred</span>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Category</span>
                <div class="filter-chips" id="categoryChips">
                    <span class="chip active" onclick="setFilter('cat', 'all')">All</span>
                    </div>
            </div>
        </div>

        <button id="btnPlayFiltered" class="btn-play-selected" onclick="playFilteredList()" style="display:none">‚ñ∂ Play Selected Words</button>

        <div id="wordList" class="word-list"></div>
        <button id="btnShowMore" class="btn-show-more" onclick="showMoreWords()">Show More</button>
      </div>

    </div>

  </div>

  <div class="modal-overlay" id="editModal">
      <div class="modal-box">
          <h3 style="color:#fff; margin-top:0">Edit Card</h3>
          <div class="form-group">
              <label>Spanish</label>
              <input type="text" id="editEs" class="form-input">
          </div>
          <div class="form-group">
              <label>English</label>
              <input type="text" id="editEn" class="form-input">
          </div>
          <div style="display:flex; gap:10px; margin-top:20px;">
              <button class="btn-action ghost" onclick="closeEditModal()">Cancel</button>
              <button class="btn-action primary" onclick="saveEdit()">Save</button>
          </div>
      </div>
  </div>

</div>

<script>
/** APP STATE **/
const STATE = {
  activeDecks: [],
  customCards: {}, 
  progress: {}, 
  blacklist: new Set(),
  starred: new Set(),
  struggleList: new Set(), // Replaces Learning logic
  
  // Manage Words State
  filterStatus: 'all',
  filterCat: 'all',
  visibleCount: 25,
  sortAsc: true,

  // Session
  currentCard: null,
  sessionStats: { correctFirst: 0, struggle: 0 },
  sessionAttempts: {}, // Track attempts this session for logic
  customSessionList: null, // For Playing filtered list
  streak: 0
};

const FUN_FACTS = [
    "Spanish is the second most spoken native language.",
    "The letter '√±' is unique to Spanish.",
    "Spanish is spoken in 20+ countries.",
    "Upside down question marks are cool! ¬øNo?",
    "Spanish comes from Latin."
];

// INIT
async function init() {
  const minLoadTime = new Promise(resolve => setTimeout(resolve, 2000)); // Min 2s load
  const dataLoad = loadData();
  
  const factEl = document.getElementById('funFactText');
  factEl.textContent = FUN_FACTS[Math.floor(Math.random()*FUN_FACTS.length)];
  
  await Promise.all([minLoadTime, dataLoad]);
  
  document.getElementById('loadingScreen').style.opacity = '0';
  setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
  
  bindEvents();
  renderDecks();
  updateStats();
  populateTopics();
}

async function loadData() {
    // Fake Fetch for demo
    const raw = await fetch('decks.json').then(r => r.ok ? r.json() : {decks:[], topics:[]});
    STATE.decksRaw = raw;
    STATE.activeDecks = raw.decks.map(d => ({...d, cards: [...d.cards]}));
    
    // LocalStorage
    const custom = localStorage.getItem('sf_custom');
    if(custom) STATE.customCards = JSON.parse(custom);
    injectCustomCards();

    const prog = localStorage.getItem('sf_progress');
    if(prog) STATE.progress = JSON.parse(prog);
    
    const starred = localStorage.getItem('sf_starred');
    if(starred) STATE.starred = new Set(JSON.parse(starred));
    
    const struggle = localStorage.getItem('sf_struggle');
    if(struggle) STATE.struggleList = new Set(JSON.parse(struggle));
    
    const black = localStorage.getItem('sf_blacklist');
    if(black) STATE.blacklist = new Set(JSON.parse(black));
}

function saveData() {
    localStorage.setItem('sf_custom', JSON.stringify(STATE.customCards));
    localStorage.setItem('sf_progress', JSON.stringify(STATE.progress));
    localStorage.setItem('sf_starred', JSON.stringify([...STATE.starred]));
    localStorage.setItem('sf_struggle', JSON.stringify([...STATE.struggleList]));
    localStorage.setItem('sf_blacklist', JSON.stringify([...STATE.blacklist]));
}

function injectCustomCards() {
  STATE.activeDecks.forEach(deck => {
    const topicCards = STATE.customCards[deck.topicId] || [];
    topicCards.forEach(c => {
       const exists = deck.cards.find(ex => ex.es === c.es && ex._custom);
       if(!exists) deck.cards.push(c);
       else Object.assign(exists, c);
    });
  });
}

// --- CORE FUNCTIONS ---

function getCardId(deckId, card) { return `${deckId}:${card.es.replace(/\s/g,'')}`; }

function updateStats() {
    let known = 0;
    Object.entries(STATE.progress).forEach(([uid, p]) => {
        if(STATE.blacklist.has(uid)) return;
        if(p.score >= 4) known++;
    });
    
    document.getElementById('statKnown').textContent = known;
    document.getElementById('statStruggle').textContent = STATE.struggleList.size;
    document.getElementById('statStarred').textContent = STATE.starred.size;
}

// --- GAME LOGIC (STRUGGLE UPDATE) ---

function startSession(deckId) {
    STATE.sessionAttempts = {};
    STATE.streak = 0;
    
    // Build Pool
    let pool = [];
    STATE.activeDecks.forEach(d => {
        if(deckId && d.id !== deckId) return;
        d.cards.forEach(c => {
            const uid = getCardId(d.id, c);
            if(!STATE.blacklist.has(uid)) {
                pool.push({...c, _uid: uid, _deckName: d.name});
            }
        });
    });

    if(pool.length === 0) return alert("No cards!");
    STATE.sessionPool = pool;
    switchPanel('game');
    nextCard();
}

function playFilteredList() {
    if(!STATE.customSessionList || STATE.customSessionList.length === 0) return;
    
    STATE.sessionAttempts = {};
    STATE.streak = 0;
    STATE.sessionPool = STATE.customSessionList;
    
    switchPanel('game');
    nextCard();
}

function nextCard() {
    if(STATE.sessionPool.length === 0) {
        alert("Session Complete!");
        switchPanel('decks');
        return;
    }
    
    // Pick random
    const idx = Math.floor(Math.random() * STATE.sessionPool.length);
    STATE.currentCard = STATE.sessionPool[idx];
    renderGameCard();
}

function renderGameCard() {
    const c = STATE.currentCard;
    document.getElementById('gameDeckName').textContent = c._deckName || 'Custom';
    document.getElementById('gameFrontText').textContent = c.es;
    document.getElementById('gameBackText').textContent = c.en;
    
    document.getElementById('gameReveal').style.display = 'none';
    document.getElementById('gameControlsStart').style.display = 'flex';
    document.getElementById('gameControlsJudge').style.display = 'none';
    document.getElementById('gameControlsNext').style.display = 'none';
    
    // Styles
    const cardEl = document.getElementById('gameCard');
    cardEl.classList.remove('correct', 'wrong');
    
    const btnStar = document.getElementById('btnStarCard');
    btnStar.style.color = STATE.starred.has(c._uid) ? '#eab308' : '#64748b';
}

function showAnswer() {
    document.getElementById('gameReveal').style.display = 'block';
    document.getElementById('gameControlsStart').style.display = 'none';
    document.getElementById('gameControlsJudge').style.display = 'flex';
}

function markCard(success) {
    const uid = STATE.currentCard._uid;
    if(!STATE.progress[uid]) STATE.progress[uid] = { score: 0 };
    
    // Track attempts in this specific session
    if(!STATE.sessionAttempts[uid]) STATE.sessionAttempts[uid] = 0;
    STATE.sessionAttempts[uid]++;

    const cardEl = document.getElementById('gameCard');

    if(success) {
        STATE.streak++;
        if(STATE.streak % 5 === 0) {
            cardEl.classList.add('streak-flash');
            setTimeout(()=>cardEl.classList.remove('streak-flash'), 500);
        }
        cardEl.classList.add('correct');
        
        // STRUGGLE LOGIC:
        // Only remove from struggle if it's the FIRST time seeing it in this session
        if(STATE.sessionAttempts[uid] === 1 && STATE.struggleList.has(uid)) {
            STATE.struggleList.delete(uid);
        }
        
        STATE.progress[uid].score = 4; // Mark known
    } else {
        STATE.streak = 0;
        cardEl.classList.add('wrong');
        
        // STRUGGLE LOGIC:
        // Any mistake adds it to struggle
        STATE.struggleList.add(uid);
        
        STATE.progress[uid].score = Math.max(0, STATE.progress[uid].score - 1);
    }
    
    saveData();
    updateStats();
    
    // Wait small delay then next
    setTimeout(() => {
        // Remove card from pool if correct? Or keep cycling? 
        // Simple trainer: remove if correct to avoid repetition in session
        if(success) {
            STATE.sessionPool = STATE.sessionPool.filter(c => c._uid !== uid);
        }
        nextCard();
    }, 600);
}

// --- WORDS MANAGER UI ---

function showWordsMenu() {
    document.getElementById('wordsMenu').style.display = 'block';
    document.getElementById('sectionAdd').style.display = 'none';
    document.getElementById('sectionManage').style.display = 'none';
}

function showAddSection() {
    document.getElementById('wordsMenu').style.display = 'none';
    document.getElementById('sectionAdd').style.display = 'block';
}

function showManageSection() {
    document.getElementById('wordsMenu').style.display = 'none';
    document.getElementById('sectionManage').style.display = 'block';
    resetPaginationAndRender();
}

function openWordsManagerFromHeader(filterType) {
    switchPanel('words');
    showManageSection();
    // Reset filters then apply specific
    STATE.filterStatus = filterType;
    STATE.filterCat = 'all';
    updateFilterChips();
    resetPaginationAndRender();
}

// FILTER LOGIC
function toggleFilterUI() {
    const ui = document.getElementById('filterUI');
    ui.style.display = ui.style.display === 'block' ? 'none' : 'block';
}

function populateTopics() {
    const select = document.getElementById('addTopicSelect');
    const chipContainer = document.getElementById('categoryChips');
    // Default "All" chip is hardcoded in HTML
    
    if(STATE.decksRaw.topics) {
        STATE.decksRaw.topics.forEach(t => {
            // Select dropdown
            const opt = document.createElement('option');
            opt.value = t.id; opt.textContent = t.label;
            select.appendChild(opt);
            
            // Filter Chip
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = t.label;
            chip.onclick = () => setFilter('cat', t.id);
            chip.id = `f-cat-${t.id}`;
            chipContainer.appendChild(chip);
        });
    }
}

function setFilter(type, val) {
    if(type === 'status') STATE.filterStatus = val;
    if(type === 'cat') STATE.filterCat = val;
    updateFilterChips();
    resetPaginationAndRender();
}

function updateFilterChips() {
    // Status
    document.querySelectorAll('.filter-group .chip').forEach(c => c.classList.remove('active'));
    document.getElementById(`f-stat-${STATE.filterStatus}`)?.classList.add('active');
    
    // Category (Manual find because ID might be dynamic)
    const catId = STATE.filterCat === 'all' ? 'all' : STATE.filterCat;
    // Iterate chips to highlight correct category
    const chips = document.getElementById('categoryChips').children;
    for(let c of chips) {
        if(c.textContent === 'All' && STATE.filterCat === 'all') c.classList.add('active');
        else if(c.id === `f-cat-${STATE.filterCat}`) c.classList.add('active');
    }
}

function toggleSort() {
    STATE.sortAsc = !STATE.sortAsc;
    resetPaginationAndRender();
}

function resetPaginationAndRender() {
    STATE.visibleCount = 25;
    renderWordList();
}

function showMoreWords() {
    STATE.visibleCount += 25;
    renderWordList();
}

function renderWordList() {
    const listEl = document.getElementById('wordList');
    const search = document.getElementById('searchInput').value.toLowerCase();
    listEl.innerHTML = '';
    
    let allWords = [];
    
    // 1. Gather Data
    STATE.activeDecks.forEach(d => {
        d.cards.forEach(c => {
            const uid = getCardId(d.id, c);
            if(STATE.blacklist.has(uid)) return;
            
            // Logic for status
            const p = STATE.progress[uid] || {score:0};
            let status = 'new';
            if(p.score >= 4) status = 'known';
            if(STATE.struggleList.has(uid)) status = 'struggle';
            
            // Filter Status
            if(STATE.filterStatus !== 'all') {
                if(STATE.filterStatus === 'starred' && !STATE.starred.has(uid)) return;
                if(STATE.filterStatus === 'known' && status !== 'known') return;
                if(STATE.filterStatus === 'struggle' && status !== 'struggle') return;
            }
            
            // Filter Category
            if(STATE.filterCat !== 'all' && d.topicId !== STATE.filterCat) return;
            
            // Search
            if(search && !c.es.toLowerCase().includes(search) && !c.en.toLowerCase().includes(search)) return;
            
            allWords.push({...c, _uid: uid, _deckName: d.name, _status: status});
        });
    });

    // 2. Sort
    allWords.sort((a,b) => {
        return STATE.sortAsc 
            ? a.es.localeCompare(b.es) 
            : b.es.localeCompare(a.es);
    });

    // 3. Play Filtered Button
    const btnPlay = document.getElementById('btnPlayFiltered');
    if(allWords.length > 0 && (STATE.filterStatus !== 'all' || STATE.filterCat !== 'all')) {
        btnPlay.style.display = 'block';
        btnPlay.textContent = `‚ñ∂ Play ${allWords.length} Selected Words`;
        STATE.customSessionList = allWords;
    } else {
        btnPlay.style.display = 'none';
        STATE.customSessionList = null;
    }

    // 4. Pagination
    const visibleList = allWords.slice(0, STATE.visibleCount);
    
    if(visibleList.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; color:#64748b; padding:20px;">No words found.</div>';
        document.getElementById('btnShowMore').style.display = 'none';
        return;
    }

    visibleList.forEach(c => {
        const isStruggle = c._status === 'struggle';
        const isStarred = STATE.starred.has(c._uid);
        
        const row = document.createElement('div');
        row.className = 'word-row';
        if(isStruggle) row.style.borderColor = 'rgba(239,68,68,0.3)';
        
        row.innerHTML = `
            <div>
                <div class="word-main">
                    ${isStarred ? '<span style="color:#eab308">‚òÖ</span>' : ''} 
                    ${c.es} 
                    <span style="font-weight:400; color:#94a3b8">‚Äî ${c.en}</span>
                </div>
                <div class="word-sub">${c._deckName} ${isStruggle ? '‚Ä¢ <span style="color:#fca5a5">Struggle</span>' : ''}</div>
            </div>
            <div>
                <button class="icon-btn" style="width:30px; height:30px; display:inline-flex;" onclick="openEditModal('${c._uid}')">‚úèÔ∏è</button>
            </div>
        `;
        listEl.appendChild(row);
    });

    // Show More Button
    const btnMore = document.getElementById('btnShowMore');
    btnMore.style.display = (allWords.length > STATE.visibleCount) ? 'block' : 'none';
}

// --- UTILS & BINDINGS ---
function toggleStar() {
    const uid = STATE.currentCard._uid;
    if(STATE.starred.has(uid)) STATE.starred.delete(uid);
    else STATE.starred.add(uid);
    saveData();
    renderGameCard();
    updateStats();
}

let editingUid = null;
function openEditModal(uid) {
    editingUid = uid;
    // Find card data...
    let found = null;
    STATE.activeDecks.forEach(d => {
        const c = d.cards.find(x => getCardId(d.id, x) === uid);
        if(c) found = c;
    });
    
    if(found) {
        document.getElementById('editEs').value = found.es;
        document.getElementById('editEn').value = found.en;
        document.getElementById('editModal').style.display = 'flex';
    }
}

function saveEdit() {
    const es = document.getElementById('editEs').value;
    const en = document.getElementById('editEn').value;
    // Update logic omitted for brevity (same as previous iteration)
    // Close modal
    document.getElementById('editModal').style.display = 'none';
    showManageSection(); // Refresh
}

function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

function onAddSubmit() {
    // Add logic similar to previous iteration
    const es = document.getElementById('addEs').value;
    if(es) {
        document.getElementById('addMsg').textContent = "Saved!";
        setTimeout(()=>document.getElementById('addMsg').textContent = "", 2000);
    }
}

function switchPanel(id) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.nav-tab[data-panel="${id}"]`)?.classList.add('active');
    
    if(id === 'decks') renderDecks();
    if(id === 'words') showWordsMenu(); // Default to menu
}

function renderDecks() {
    const grid = document.getElementById('deckGrid');
    grid.innerHTML = '';
    STATE.activeDecks.forEach(d => {
        const el = document.createElement('div');
        el.className = 'deck-card';
        el.innerHTML = `<div class="deck-title">${d.name}</div><div class="deck-count">${d.cards.length} cards</div>`;
        el.onclick = () => startSession(d.id);
        grid.appendChild(el);
    });
}

function bindEvents() {
    document.querySelectorAll('.nav-tab').forEach(b => b.onclick = () => switchPanel(b.dataset.panel));
}

// Boot
init();

</script>
</body>
</html>
